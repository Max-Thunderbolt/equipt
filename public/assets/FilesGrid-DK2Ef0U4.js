import{r as k,s as i,_ as M,h as S,c,o as d,a as l,t as h,n as E,F as L,k as R,b as x,j as C,D as z,p as $,e as q}from"./index-BzJ7YkvY.js";function V(){const s=k(!1),a=k(null),u=k(0),f=async(e,o,t=null)=>{var r;if(!e||!o)return a.value="File and project ID are required",null;s.value=!0,a.value=null,u.value=0;try{console.log(`Starting upload for file: ${e.name} (${(e.size/1024).toFixed(1)} KB)`);const n=`projects/${o}/${Date.now()}_${e.name}`,{data:B,error:v}=await i.storage.from("project-files").upload(n,e,{cacheControl:"3600",upsert:!1,onProgress:b=>{b.totalBytes&&(u.value=Math.round(b.loadedBytes/b.totalBytes*100))}});if(v)throw console.error("Storage upload error:",v),v;console.log(`File uploaded to path: ${n}`);const{data:p}=i.storage.from("project-files").getPublicUrl(n);!p||!p.publicUrl?console.warn("Could not generate public URL for file"):console.log(`Generated URL: ${p.publicUrl}`);const D={project_id:o,name:e.name,file_path:n,file_type:e.type,size_bytes:e.size,uploaded_by:(r=(await i.auth.getUser()).data.user)==null?void 0:r.id,update_id:t,url:(p==null?void 0:p.publicUrl)||null,created_at:new Date().toISOString()};console.log("Creating file record with data:",D);const{data:j,error:y}=await i.from("project_files").insert(D).select().single();if(y)throw console.error("Database file record error:",y),y;return console.log("File record created successfully:",j),j}catch(n){return console.error("Error uploading file:",n),a.value=n.message,null}finally{s.value=!1}},m=async e=>{a.value=null;try{if(!e)return a.value="File path is required",null;if(e.startsWith("http"))return window.open(e,"_blank"),!0;const{data:o,error:t}=await i.storage.from("project-files").download(e);if(t)throw t;const r=URL.createObjectURL(o),n=document.createElement("a"),B=e.split("/").pop();return n.href=r,n.download=B,document.body.appendChild(n),n.click(),setTimeout(()=>{URL.revokeObjectURL(r),document.body.removeChild(n)},100),!0}catch(o){return console.error("Error downloading file:",o),a.value=o.message,!1}},_=e=>{if(!e)return null;const{data:o}=i.storage.from("project-files").getPublicUrl(e);return o==null?void 0:o.publicUrl},w=async(e,o)=>{if(!e||!o)return a.value="File path and ID are required",!1;a.value=null;try{const{error:t}=await i.storage.from("project-files").remove([e]);if(t)throw t;const{error:r}=await i.from("project_files").delete().eq("id",o);if(r)throw r;return!0}catch(t){return console.error("Error deleting file:",t),a.value=t.message,!1}},g=async(e,o)=>{if(!e||!o)return a.value="File ID and path are required",!1;a.value=null;try{const{data:t}=i.storage.from("project-files").getPublicUrl(o);if(!t||!t.publicUrl)return console.warn("Could not generate public URL for file"),!1;const{error:r}=await i.from("project_files").update({url:t.publicUrl}).eq("id",e);return r?(console.error("Error updating file URL:",r),!1):!0}catch(t){return console.error("Error updating file URL:",t),a.value=t.message,!1}};return{uploading:s,error:a,progress:u,uploadFile:f,downloadFile:m,getFileUrl:_,deleteFile:w,updateFileUrl:g,updateMissingFileUrls:async e=>{if(!e||!e.length)return;const o=e.filter(t=>!t.url&&t.file_path).map(t=>g(t.id,t.file_path));return Promise.all(o)}}}const F=s=>($("data-v-83201e7d"),s=s(),q(),s),G={class:"files-grid-container"},I={key:0,class:"loading-container"},N=F(()=>l("div",{class:"loading-spinner"},null,-1)),O=F(()=>l("p",null,"Loading files...",-1)),H=[N,O],K={key:1,class:"empty-state"},T={class:"file-info"},A={class:"filename-container"},W=["title"],J={class:"file-meta"},P={class:"file-size"},Q={key:0,class:"file-date"},X={class:"file-actions"},Y=["onClick"],Z=F(()=>l("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"18",height:"18",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[l("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),l("polyline",{points:"7 10 12 15 17 10"}),l("line",{x1:"12",y1:"15",x2:"12",y2:"3"})],-1)),ee=[Z],te=["onClick"],oe=z('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-83201e7d><polyline points="3 6 5 6 21 6" data-v-83201e7d></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" data-v-83201e7d></path><line x1="10" y1="11" x2="10" y2="17" data-v-83201e7d></line><line x1="14" y1="11" x2="14" y2="17" data-v-83201e7d></line></svg>',1),re=[oe],ae={__name:"FilesGrid",props:{files:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},viewMode:{type:String,default:"grid"},layout:{type:String,default:"standard"},allowDelete:{type:Boolean,default:!1},emptyMessage:{type:String,default:"No files found"}},emits:["delete","preview","download"],setup(s,{emit:a}){const u=s;V();const f=a,m=async e=>{f("download",e)},_=e=>{f("delete",e)},w=e=>{if(!e)return"0 B";const o=1024,t=["B","KB","MB","GB","TB"],r=Math.floor(Math.log(e)/Math.log(o));return parseFloat((e/Math.pow(o,r)).toFixed(1))+" "+t[r]},g=e=>e?new Date(e).toLocaleDateString():"",U=S(()=>{const e=[u.layout];return u.viewMode==="grid"?e.push("grid-view"):e.push("list-view"),e.join(" ")});return(e,o)=>(d(),c("div",G,[s.loading?(d(),c("div",I,H)):s.files.length===0?(d(),c("div",K,[l("p",null,h(s.emptyMessage),1)])):(d(),c("div",{key:2,class:E(["files-grid",U.value])},[(d(!0),c(L,null,R(s.files,t=>(d(),c("div",{key:t.id,class:"file-item"},[l("div",T,[l("div",A,[l("h3",{class:"file-name",title:t.name||t.filename},h(t.name||t.filename),9,W)]),l("div",J,[l("span",P,h(w(t.size||t.size_bytes)),1),t.created_at?(d(),c("span",Q,h(g(t.created_at)),1)):x("",!0)])]),l("div",X,[l("button",{class:"action-btn download-btn",onClick:C(r=>m(t),["stop"]),title:"Download"},ee,8,Y),s.allowDelete?(d(),c("button",{key:0,class:"action-btn delete-btn",onClick:C(r=>_(t),["stop"]),title:"Delete"},re,8,te)):x("",!0)])]))),128))],2))]))}},le=M(ae,[["__scopeId","data-v-83201e7d"]]);export{le as F,V as u};
